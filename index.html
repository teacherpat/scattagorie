import { initializeApp } from "firebase/app";
import { getFirestore, doc, setDoc, updateDoc, getDoc, collection, query, orderBy, limit, getDocs } from "firebase/firestore";
import { getStorage, ref, uploadBytes, getDownloadURL } from "firebase/storage";
import { useState, useEffect } from "react";

const firebaseConfig = {
  apiKey: "YOUR_API_KEY",
  authDomain: "YOUR_AUTH_DOMAIN",
  projectId: "YOUR_PROJECT_ID",
  storageBucket: "YOUR_STORAGE_BUCKET",
  messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
  appId: "YOUR_APP_ID"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const storage = getStorage(app);

async function createGameSession(playerName, difficulty) {
  const gameId = Math.random().toString(36).substr(2, 9);
  await setDoc(doc(db, "games", gameId), {
    player: playerName,
    difficulty: difficulty,
    score: 0,
    createdAt: new Date(),
    wordsPlayed: [],
    currentRound: 0,
    gameOver: false
  });
  return gameId;
}

async function updateScore(gameId, newScore) {
  await updateDoc(doc(db, "games", gameId), {
    score: newScore
  });
}

async function getLeaderboard() {
  const q = query(collection(db, "games"), orderBy("score", "desc"), limit(10));
  const querySnapshot = await getDocs(q);
  let leaderboard = [];
  querySnapshot.forEach(doc => {
    leaderboard.push(doc.data());
  });
  return leaderboard;
}

async function generateTTS(word) {
  const ttsUrl = `https://api.tts.example.com/generate?text=${word}`;
  const audio = new Audio(ttsUrl);
  await audio.play();
}

async function checkPlayerInput(gameId, playerInputs, correctWords) {
  const gameRef = doc(db, "games", gameId);
  const gameSnap = await getDoc(gameRef);
  if (gameSnap.exists()) {
    let gameData = gameSnap.data();
    let currentScore = gameData.score;
    let roundResults = [];
    let roundScore = 0;

    for (let i = 0; i < correctWords.length; i++) {
      let isCorrect = playerInputs[i].toLowerCase().trim() === correctWords[i].toLowerCase().trim();
      if (isCorrect) {
        currentScore += 1;
        roundScore += 1;
      }
      roundResults.push({ word: correctWords[i], playerInput: playerInputs[i], correct: isCorrect });
    }

    await updateDoc(gameRef, {
      score: currentScore,
      wordsPlayed: [...gameData.wordsPlayed, ...roundResults],
      currentRound: gameData.currentRound + 1
    });

    return { roundResults, roundScore, totalScore: currentScore };
  }
  return null;
}

async function endGame(gameId) {
  await updateDoc(doc(db, "games", gameId), {
    gameOver: true
  });
}

export { createGameSession, updateScore, getLeaderboard, generateTTS, checkPlayerInput, endGame };

function GameUI() {
  const [playerName, setPlayerName] = useState("");
  const [difficulty, setDifficulty] = useState("A1");
  const [gameId, setGameId] = useState(null);
  const [words, setWords] = useState([]);
  const [playerInputs, setPlayerInputs] = useState(["", "", "", ""]);
  const [score, setScore] = useState(0);
  const [timeLeft, setTimeLeft] = useState(100);
  const [roundResults, setRoundResults] = useState([]);

  useEffect(() => {
    if (timeLeft > 0) {
      const timer = setTimeout(() => setTimeLeft(timeLeft - 1), 1000);
      return () => clearTimeout(timer);
    }
  }, [timeLeft]);

  const startGame = async () => {
    const newGameId = await createGameSession(playerName, difficulty);
    setGameId(newGameId);
  };

  const submitAnswers = async () => {
    const correctWords = words;
    const result = await checkPlayerInput(gameId, playerInputs, correctWords);
    if (result) {
      setRoundResults(result.roundResults);
      setScore(result.totalScore);
    }
    setTimeout(() => setRoundResults([]), 2000);
  };

  return (
    <div>
      {!gameId ? (
        <div>
          <input type="text" placeholder="Enter Name" onChange={(e) => setPlayerName(e.target.value)} />
          <select onChange={(e) => setDifficulty(e.target.value)}>
            <option value="A1">A1</option>
            <option value="A2">A2</option>
            <option value="B1">B1</option>
            <option value="B2">B2</option>
            <option value="C1">C1</option>
            <option value="C2">C2</option>
          </select>
          <button onClick={startGame}>Start Game</button>
        </div>
      ) : (
        <div>
          <p>Time Left: {timeLeft} seconds</p>
          <p>Score: {score}</p>
          {words.map((word, index) => (
            <input key={index} type="text" value={playerInputs[index]} 
              onChange={(e) => {
                let newInputs = [...playerInputs];
                newInputs[index] = e.target.value;
                setPlayerInputs(newInputs);
              }}
              onKeyDown={(e) => e.key === "Enter" && submitAnswers()}
            />
          ))}
          <button onClick={submitAnswers}>Submit Answers</button>
        </div>
      )}
    </div>
  );
}

export default GameUI;
